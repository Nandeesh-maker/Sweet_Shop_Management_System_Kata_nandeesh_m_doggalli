import express from 'express';
import cors from 'cors';
import dotenv from 'dotenv';

// Load environment variables
dotenv.config();

const app = express();
const PORT = process.env.PORT || 3000;

// Middleware
app.use(cors({
  origin: 'http://localhost:3001',
  credentials: true
}));
app.use(express.json());

// Simple in-memory data store
let sweets = [
  { id: 1, name: 'Chocolate Bar', category: 'chocolate', price: 2.99, quantity: 50 },
  { id: 2, name: 'Gummy Bears', category: 'gummies', price: 1.99, quantity: 100 },
  { id: 3, name: 'Lollipop', category: 'candy', price: 0.99, quantity: 75 }
];

let users: any[] = [];

// ===== HEALTH CHECK =====
app.get('/api/health', (req, res) => {
  res.status(200).json({ 
    status: 'OK', 
    message: 'Sweet Shop API is running!',
    timestamp: new Date().toISOString()
  });
});

// ===== AUTH ROUTES =====
app.post('/api/auth/register', (req, res) => {
  try {
    const { email, password, name } = req.body;
    
    if (!email || !password || !name) {
      return res.status(400).json({ error: 'Email, password, and name are required' });
    }
    
    // Check if user exists
    const existingUser = users.find(user => user.email === email);
    if (existingUser) {
      return res.status(400).json({ error: 'User already exists' });
    }
    
    // Create user
    const newUser = {
      id: users.length + 1,
      email,
      password, // In real app, hash this!
      name,
      role: 'user'
    };
    
    users.push(newUser);
    
    res.status(201).json({
      message: 'User registered successfully',
      user: { id: newUser.id, email: newUser.email, name: newUser.name, role: newUser.role }
    });
  } catch (error) {
    res.status(500).json({ error: 'Internal server error' });
  }
});

app.post('/api/auth/login', (req, res) => {
  try {
    const { email, password } = req.body;
    
    if (!email || !password) {
      return res.status(400).json({ error: 'Email and password are required' });
    }
    
    const user = users.find(u => u.email === email && u.password === password);
    if (!user) {
      return res.status(401).json({ error: 'Invalid credentials' });
    }
    
    const token = `mock-jwt-token-${user.id}`;
    
    res.json({
      message: 'Login successful',
      token,
      user: { id: user.id, email: user.email, name: user.name, role: user.role }
    });
  } catch (error) {
    res.status(500).json({ error: 'Internal server error' });
  }
});

// ===== SWEETS ROUTES =====
app.get('/api/sweets', (req, res) => {
  res.json({
    message: 'Sweets retrieved successfully',
    data: sweets,
    count: sweets.length
  });
});

app.get('/api/sweets/search', (req, res) => {
  const { name, category, minPrice, maxPrice } = req.query;
  
  let filteredSweets = [...sweets];
  
  if (name) {
    filteredSweets = filteredSweets.filter(sweet => 
      sweet.name.toLowerCase().includes((name as string).toLowerCase())
    );
  }
  
  if (category) {
    filteredSweets = filteredSweets.filter(sweet => 
      sweet.category.toLowerCase() === (category as string).toLowerCase()
    );
  }
  
  if (minPrice) {
    filteredSweets = filteredSweets.filter(sweet => 
      sweet.price >= parseFloat(minPrice as string)
    );
  }
  
  if (maxPrice) {
    filteredSweets = filteredSweets.filter(sweet => 
      sweet.price <= parseFloat(maxPrice as string)
    );
  }
  
  res.json({
    message: 'Search completed',
    data: filteredSweets,
    count: filteredSweets.length
  });
});

app.post('/api/sweets', (req, res) => {
  const { name, category, price, quantity } = req.body;
  
  if (!name || !category || !price || !quantity) {
    return res.status(400).json({ error: 'All fields are required' });
  }
  
  const newSweet = {
    id: sweets.length + 1,
    name,
    category,
    price: parseFloat(price),
    quantity: parseInt(quantity)
  };
  
  sweets.push(newSweet);
  
  res.status(201).json({
    message: 'Sweet added successfully',
    data: newSweet
  });
});

// ===== INVENTORY ROUTES =====
app.post('/api/inventory/:id/purchase', (req, res) => {
  const sweetId = parseInt(req.params.id);
  const { quantity = 1 } = req.body;
  
  const sweet = sweets.find(s => s.id === sweetId);
  
  if (!sweet) {
    return res.status(404).json({ error: 'Sweet not found' });
  }
  
  if (sweet.quantity < quantity) {
    return res.status(400).json({ error: 'Insufficient quantity available' });
  }
  
  sweet.quantity -= quantity;
  
  res.json({
    message: 'Purchase successful',
    data: { sweet, quantityPurchased: quantity, remainingQuantity: sweet.quantity }
  });
});

app.post('/api/inventory/:id/restock', (req, res) => {
  const sweetId = parseInt(req.params.id);
  const { quantity = 10 } = req.body;
  
  const sweet = sweets.find(s => s.id === sweetId);
  
  if (!sweet) {
    return res.status(404).json({ error: 'Sweet not found' });
  }
  
  sweet.quantity += quantity;
  
  res.json({
    message: 'Restock successful',
    data: { sweet, quantityAdded: quantity, newQuantity: sweet.quantity }
  });
});

// Root endpoint
app.get('/', (req, res) => {
  res.json({ 
    message: 'Welcome to Sweet Shop Management System API',
    version: '1.0.0',
    endpoints: {
      health: '/api/health',
      auth: {
        register: 'POST /api/auth/register',
        login: 'POST /api/auth/login'
      },
      sweets: {
        list: 'GET /api/sweets',
        search: 'GET /api/sweets/search',
        add: 'POST /api/sweets'
      },
      inventory: {
        purchase: 'POST /api/inventory/:id/purchase',
        restock: 'POST /api/inventory/:id/restock'
      }
    }
  });
});

// 404 handler
app.use('*', (req, res) => {
  res.status(404).json({ error: 'Route not found' });
});

// Start server
app.listen(PORT, () => {
  console.log(`ğŸª Sweet Shop Management System is running!`);
  console.log(`ğŸ“Š Backend API: http://localhost:${PORT}`);
  console.log(`âœ… Health check: http://localhost:${PORT}/api/health`);
  console.log(`ï¿½ï¿½ API Docs: http://localhost:${PORT}/`);
});
